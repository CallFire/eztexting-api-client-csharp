import org.gradle.internal.os.OperatingSystem
import groovy.xml.XmlUtil

plugins {
  id 'com.ullink.msbuild' version '2.14'
  id 'com.ullink.nuget' version '2.12'
  id 'com.ullink.nunit' version '1.4'
  id 'com.ullink.opencover' version '1.2'
  id 'net.researchgate.release' version '2.3.4'
}

archivesBaseName = 'EzTextingApiClient'
ext['buildConfiguration'] = OperatingSystem.current().unix ? 'Release' : 'Release'
ext['assemblyBinDir'] = "src/EzTextingApiClient/bin/$buildConfiguration"
ext['buildDistDir'] = "$buildDir/dist"
ext['assemblyInfo'] = "src/EzTextingApiClient/Properties/AssemblyInfo.cs"

defaultTasks('nugetPack')

nuget {
    // oh boy, version 3.3.0 seems to freeze during restore on linux ... rollbacking.... again
    version = '2.8.6'
}

msbuild.dependsOn nugetRestore
msbuild {
    solutionFile = 'eztexting-api-client-csharp.sln'
    configuration = buildConfiguration
    projectName = 'EzTextingApiClient'
    generateDoc = true
    inputs.file(project.buildFile)
}

nunit {
    testAssemblies = [ msbuild.projects['EzTextingApiClient.Tests'].properties.TargetPath ]
}
nunit.dependsOn msbuild

task updateNuspecFile << {
    def specFile = file('EzTextingApiClient.nuspec')
    def spec = new XmlSlurper().parse(specFile)

    project.version = patchVersion(spec.metadata.version.text)
    spec.metadata.version = project.version
    spec.metadata.releaseNotes = file('Changelog').text
    // cleanup previous lib/ files since they depend on build configuration
    spec.files.file.findAll { it.@target == 'lib' }.each { it.replaceNode {} }
    spec.files.appendNode {
        file(src: "$assemblyBinDir/${archivesBaseName}.dll", target: 'lib') {
        }
        file(src: "$assemblyBinDir/${archivesBaseName}.dll.config", target: 'lib') {
        }
        file(src: "$assemblyBinDir/${archivesBaseName}.xml", target: 'lib') {
        }
    }
    XmlUtil.serialize(spec, new FileWriter('EzTextingApiClient.nuspec'))
}

def patchVersion(version) {
    def regex = ~/\[assembly: AssemblyVersion\("(.*)\.\*"\)\]/
    def matcher = regex.matcher(new File(assemblyInfo).text)
    while(matcher.find()) {
        def updated = matcher.group(1)
        println "Patching Nuspec version to $updated"
        return updated
    }
    version
}

task zipBinaries(type: Zip) {
    destinationDir = file(buildDistDir)
    from 'LICENSE'
    from 'Changelog'
    from (assemblyBinDir) {
        include "${archivesBaseName}.*"
    }
}
zipBinaries.dependsOn nunit

// nuget package for upload to nuget
nugetSpec {
    nuspecFile = file('EzTextingApiClient.nuspec')
}
nugetSpec.dependsOn updateNuspecFile

nugetPack {
    destinationDir = buildDistDir
    generateSymbols = true
}
nugetPack.dependsOn zipBinaries

// nuget package upload, requires API key to be set
nugetPush {
    apiKey = System.properties[ 'NUGET_API_KEY' ] ?: "key not set"
    nupkgFile = nugetPack.packageFile
}